jQuery(function(n){if("undefined"==typeof kco_params)return!1;var a={bodyEl:n("body"),checkoutFormSelector:n("form.checkout"),paymentMethodEl:n('input[name="payment_method"]'),paymentMethod:"",selectAnotherSelector:"#klarna-checkout-select-other",shippingUpdated:!1,blocked:!1,preventPaymentMethodChange:!1,timeout:null,interval:null,klarnaUpdateNeeded:!1,documentReady:function(){a.log(kco_params),0<a.paymentMethodEl.length?a.paymentMethod=a.paymentMethodEl.filter(":checked").val():a.paymentMethod="kco",a.moveExtraCheckoutFields(),a.updateShipping(!1)},kcoSuspend:function(o){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.suspend({autoResume:{enabled:o}})})},kcoResume:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){!1===a.blocked&&e.resume()})},changeFromKco:function(e){e.preventDefault(),n(a.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),n.ajax({type:"POST",dataType:"json",data:{kco:!1,nonce:kco_params.change_payment_method_nonce},url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){a.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})},maybeChangeToKco:function(){a.preventPaymentMethodChange||(a.log(n(this).val()),"kco"===n(this).val()&&(n(".woocommerce-info").remove(),n(a.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),n.ajax({type:"POST",data:{kco:!0,nonce:kco_params.change_payment_method_nonce},dataType:"json",url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){a.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})))},moveExtraCheckoutFields:function(){n(".woocommerce-additional-fields").appendTo("#kco-extra-checkout-fields");var e=n('form[name="checkout"] input, form[name="checkout"] select, textarea');for(i=0;i<e.length;i++){var o=e[i].name;n("table.woocommerce-checkout-review-order-table").find(e[i]).length||-1===n.inArray(o,kco_params.standard_woo_checkout_fields)&&(0<n("p#"+o+"_field").length?n("p#"+o+"_field"):n('input[name="'+o+'"]').closest("p")).appendTo("#kco-extra-checkout-fields")}},maybeDisplayShippingPrice:function(){var e;n(".kco-shipping").length||"kco"===a.paymentMethod&&"yes"===kco_params.shipping_methods_in_iframe&&"no"===kco_params.is_confirmation_page&&(n("#shipping_method input[type='radio']").length?n("#shipping_method input[type='radio']:checked").each(function(){var e=n(this).attr("id"),e=n("label[for='"+e+"']").text();n(".woocommerce-shipping-totals td").html(e),n(".woocommerce-shipping-totals td").addClass("kco-shipping")}):(e=n("#shipping_method input[name='shipping_method[0]']").attr("id"),e=n("label[for='"+e+"']").text(),n(".woocommerce-shipping-totals td").html(e),n(".woocommerce-shipping-totals td").addClass("kco-shipping")))},updateCart:function(){a.kcoSuspend(!0),n.ajax({type:"POST",url:kco_params.update_cart_url,data:{checkout:n("form.checkout").serialize(),nonce:kco_params.update_cart_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){n("body").trigger("update_checkout"),a.kcoResume()}})},updateKlarnaOrder:function(){"kco"===a.paymentMethod&&"no"===kco_params.is_confirmation_page&&(a.klarnaUpdateNeeded?n.ajax({type:"POST",url:kco_params.update_klarna_order_url,data:{nonce:kco_params.update_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){!0===e.responseJSON.success&&(a.kcoResume(),n(".woocommerce-checkout-review-order-table").unblock())}}):a.klarnaUpdateNeeded=!0)},getKlarnaOrder:function(){a.preventPaymentMethodChange=!0,n(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),n.ajax({type:"POST",url:kco_params.get_klarna_order_url,data:{nonce:kco_params.get_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){return!1},complete:function(e){return a.setCustomerData(e.responseJSON.data),0<n("form.checkout #terms").length&&n("form.checkout #terms").prop("checked",!0),n("form.checkout").submit(),!0}})},setCustomerData:function(e){a.log(e),"billing_address"in e&&null!==e.billing_address&&(n("#billing_first_name").val("given_name"in e.billing_address?e.billing_address.given_name:""),n("#billing_last_name").val("family_name"in e.billing_address?e.billing_address.family_name:""),n("#billing_company").val("organization_name"in e.billing_address?e.billing_address.organization_name:""),n("#billing_address_1").val("street_address"in e.billing_address?e.billing_address.street_address:""),n("#billing_address_2").val("street_address2"in e.billing_address?e.billing_address.street_address2:""),n("#billing_city").val("city"in e.billing_address?e.billing_address.city:""),n("#billing_postcode").val("postal_code"in e.billing_address?e.billing_address.postal_code:""),n("#billing_phone").val("phone"in e.billing_address?e.billing_address.phone:""),n("#billing_email").val("email"in e.billing_address?e.billing_address.email:""),n("#billing_country").val("country"in e.billing_address?e.billing_address.country.toUpperCase():""),n("#billing_state").val("region"in e.billing_address?e.billing_address.region:""),n("#billing_email").change(),n("#billing_email").blur()),"shipping_address"in e&&null!==e.shipping_address&&(n("#ship-to-different-address-checkbox").prop("checked",!0),n("#shipping_first_name").val("given_name"in e.shipping_address?e.shipping_address.given_name:""),n("#shipping_last_name").val("family_name"in e.shipping_address?e.shipping_address.family_name:""),n("#shipping_company").val("organization_name"in e.shipping_address?e.billing_address.organization_name:""),n("#shipping_address_1").val("street_address"in e.shipping_address?e.shipping_address.street_address:""),n("#shipping_address_2").val("street_address2"in e.shipping_address?e.shipping_address.street_address2:""),n("#shipping_city").val("city"in e.shipping_address?e.shipping_address.city:""),n("#shipping_postcode").val("postal_code"in e.shipping_address?e.shipping_address.postal_code:""),n("#shipping_country").val("country"in e.shipping_address?e.shipping_address.country.toUpperCase():""),n("#shipping_state").val("region"in e.shipping_address?e.shipping_address.region:""))},checkUrl:function(e){window.location.hash&&-1<window.location.hash.indexOf("#klarna-success")&&(a.logToFile("klarna-success hashtag detected in URL."),e({should_proceed:!0}),clearInterval(a.interval),clearTimeout(a.timeout),a.checkoutFormSelector.removeClass("processing"),n(".woocommerce-checkout-review-order-table").unblock(),n(a.checkoutFormSelector).unblock())},failOrder:function(e,o){a.logToFile("Timeout for validation_callback triggered."),e({should_proceed:!1}),clearInterval(a.interval),clearTimeout(a.timeout),n("body").trigger("updated_checkout"),a.checkoutFormSelector.removeClass("processing"),n(a.checkoutFormSelector).unblock(),"timeout"===o&&(n("#kco-timeout").remove(),n("form.checkout").prepend('<div id="kco-timeout" class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+kco_params.timeout_message+"</li></ul></div>"))},logToFile:function(e){n.ajax({url:kco_params.log_to_file_url,type:"POST",dataType:"json",data:{message:e,nonce:kco_params.log_to_file_nonce}})},log:function(e){kco_params.logging&&console.log(e)},updateShipping:function(o){a.kcoSuspend(!0),n.ajax({url:kco_params.update_shipping_url,type:"POST",dataType:"json",data:{data:o,nonce:kco_params.update_shipping_nonce},success:function(e){a.log(e)},error:function(e){a.log(e)},complete:function(e){a.klarnaUpdateNeeded=!1,n("#shipping_method #"+e.responseJSON.data.shipping_option_name).prop("checked",!0),n("body").trigger("kco_shipping_option_changed",[o]),n("body").trigger("update_checkout"),a.kcoResume()}})},init:function(){n(document).ready(a.documentReady),a.bodyEl.on("update_checkout",function(){a.klarnaUpdateNeeded&&a.kcoSuspend(!0)}),a.bodyEl.on("updated_checkout",a.updateKlarnaOrder),a.bodyEl.on("updated_checkout",a.maybeDisplayShippingPrice),a.bodyEl.on("change","input.qty",a.updateCart),a.bodyEl.on("change",'input[name="payment_method"]',a.maybeChangeToKco),a.bodyEl.on("click",a.selectAnotherSelector,a.changeFromKco),"function"==typeof window._klarnaCheckout&&window._klarnaCheckout(function(e){e.on({shipping_address_change:function(e){a.log("shipping_address_change"),a.log(e),n(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.kcoSuspend(!0),n.ajax({url:kco_params.iframe_shipping_address_change_url,type:"POST",dataType:"json",data:{data:e,nonce:kco_params.iframe_shipping_address_change_nonce},success:function(e){a.log(e),a.setCustomerData(e.data),n("body").trigger("update_checkout")},error:function(e){a.log(e)},complete:function(e){n(".woocommerce-checkout-review-order-table").unblock(),a.shippingUpdated=!0,a.bodyEl.trigger("kco_shipping_address_changed",e)}})},change:function(e){a.log("change",e)},order_total_change:function(e){a.log("order_total_change",e)},shipping_option_change:function(e){a.log("shipping_option_change",e),a.log(e),a.updateShipping(e)},can_not_complete_order:function(e){a.log("can_not_complete_order",e)},validation_callback:function(e,o){a.logToFile("validation_callback from Klarna triggered"),window.location.hash="",a.timeout=setTimeout(function(){a.failOrder(o,"timeout")},1e3*kco_params.timeout_time),n(document.body).on("checkout_error",function(){a.failOrder(o,"checkout_error")}),a.interval=setInterval(function(){a.checkUrl(o)},500),a.getKlarnaOrder()}})})}};a.init()});